# vim: set ts=8 sts=2 sw=2 tw=99 et ft=python:
import os
import re

builder.SetBuildFolder('package')

folder_list = [
  'addons/source2mod',
  'addons/source2mod/bin',
  'addons/source2mod/plugins',
  'addons/source2mod/plugins/disabled',
  'addons/source2mod/gamedata',
  'addons/source2mod/gamedata/core.games',
  'addons/source2mod/gamedata/sdkhooks.games',
  'addons/source2mod/gamedata/sdktools.games',
  'addons/source2mod/gamedata/sm-cstrike.games',
  'addons/source2mod/configs',
  'addons/source2mod/configs/geoip',
  'addons/source2mod/translations',
  'addons/source2mod/logs',
  'addons/source2mod/extensions',
  'addons/source2mod/data',
  'addons/source2mod/configs/sql-init-scripts',
  'addons/source2mod/configs/sql-init-scripts/mysql',
  'addons/source2mod/configs/sql-init-scripts/pgsql',
  'addons/source2mod/configs/sql-init-scripts/sqlite',
  'addons/source2mod/scripting',
  'addons/source2mod/scripting/include',
  'addons/source2mod/scripting/admin-flatfile',
  'addons/source2mod/scripting/adminmenu',
  'addons/source2mod/scripting/testsuite',
  'addons/source2mod/scripting/basecommands',
  'addons/source2mod/scripting/basecomm',
  'addons/source2mod/scripting/funvotes',
  'addons/source2mod/scripting/basevotes',
  'addons/source2mod/scripting/basebans',
  'addons/source2mod/scripting/funcommands',
  'addons/source2mod/scripting/playercommands',
  'addons/metamod',
  'cfg/source2mod',
]

if 'x86_64' in SM.target_archs:
  folder_list.extend([
    'addons/source2mod/bin/x64',
    'addons/source2mod/extensions/x64',
  ])

helpers = SM.package_helpers
helpers.builder = builder
folder_map = helpers.CreateFolders(folder_list)

# Copy binaries.
for cxx_task in SM.binaries:
  # mms expects our loader (source2mod_mm) to exist in /bin/
  if cxx_task.target.arch == 'x86_64' and not 'source2mod_mm' in cxx_task.binary.path:
    builder.AddCopy(cxx_task.binary, folder_map['addons/source2mod/bin/x64'])
  else:
    builder.AddCopy(cxx_task.binary, folder_map['addons/source2mod/bin'])
for cxx_task in SM.extensions:
  if cxx_task.target.arch == 'x86_64':
    builder.AddCopy(cxx_task.binary, folder_map['addons/source2mod/extensions/x64'])
  else:
    builder.AddCopy(cxx_task.binary, folder_map['addons/source2mod/extensions'])
for cxx_task in SM.spvm:
  if cxx_task.target.arch == 'x86':
    dest_path = os.path.join('addons/source2mod/bin',
                             'sourcepawn.jit.x86' + os.path.splitext(cxx_task.binary.path)[1])
    builder.AddCopy(cxx_task.binary, dest_path)
  elif cxx_task.target.arch == 'x86_64':
    dest_path = os.path.join('addons/source2mod/bin/x64',
                             'sourcepawn.vm' + os.path.splitext(cxx_task.binary.path)[1])
    builder.AddCopy(cxx_task.binary, dest_path)

helpers.CopySpcomp('addons/source2mod/scripting')

# Export PDB files. We write to a file in the build folder which is pretty
# verboten, but it's okay if it's in the root since AMBuild will never try
# to rmdir the root.
full_binary_list = SM.binaries + SM.extensions + SM.spvm + SM.spcomp_bins
with open(os.path.join(builder.buildPath, 'pdblog.txt'), 'w') as fp:
  for task in full_binary_list:
    fp.write(task.debug.path + '\n')

# Copy plugins.
disabled_plugins = set([
  'admin-sql-prefetch.smx',
  'admin-sql-threaded.smx',
  'sql-admin-manager.smx',
  'mapchooser.smx',
  'randomcycle.smx',
  'rockthevote.smx',
  'nominations.smx',
])

for smx_file in SM.smx_files:
  smx_entry = SM.smx_files[smx_file]
  if smx_file in disabled_plugins:
    builder.AddCopy(smx_entry, folder_map['addons/source2mod/plugins/disabled'])
  else:
    builder.AddCopy(smx_entry, folder_map['addons/source2mod/plugins'])

# Do all straight-up file copies from the source tree.
helpers.CopyIncludes('addons/source2mod/scripting/include')

helpers.CopyFiles('configs', 'addons/source2mod/configs')
helpers.CopyFiles('configs/cfg', 'cfg/source2mod')
helpers.CopyFiles('configs/metamod', 'addons/metamod')
helpers.CopyFiles('configs/sql-init-scripts/mysql', 'addons/source2mod/configs/sql-init-scripts/mysql')
helpers.CopyFiles('configs/sql-init-scripts/pgsql', 'addons/source2mod/configs/sql-init-scripts/pgsql')
helpers.CopyFiles('configs/sql-init-scripts/sqlite', 'addons/source2mod/configs/sql-init-scripts/sqlite')
helpers.CopyFiles('gamedata', 'addons/source2mod/gamedata')
helpers.CopyFiles('gamedata/sdkhooks.games', 'addons/source2mod/gamedata/sdkhooks.games')
helpers.CopyFiles('gamedata/sdktools.games', 'addons/source2mod/gamedata/sdktools.games')
helpers.CopyFiles('gamedata/core.games', 'addons/source2mod/gamedata/core.games')
helpers.CopyFiles('gamedata/sm-cstrike.games', 'addons/source2mod/gamedata/sm-cstrike.games')
helpers.CopyFiles('plugins', 'addons/source2mod/scripting', '.sp')
helpers.CopyFiles('translations', 'addons/source2mod/translations')
helpers.CopyFiles('licenses', 'addons/source2mod')
helpers.CopyFiles('plugins/admin-flatfile', 'addons/source2mod/scripting/admin-flatfile')
helpers.CopyFiles('plugins/adminmenu', 'addons/source2mod/scripting/adminmenu')
helpers.CopyFiles('plugins/testsuite', 'addons/source2mod/scripting/testsuite')
helpers.CopyFiles('plugins/basecommands', 'addons/source2mod/scripting/basecommands')
helpers.CopyFiles('plugins/basecomm', 'addons/source2mod/scripting/basecomm')
helpers.CopyFiles('plugins/funvotes', 'addons/source2mod/scripting/funvotes')
helpers.CopyFiles('plugins/basevotes', 'addons/source2mod/scripting/basevotes')
helpers.CopyFiles('plugins/basebans', 'addons/source2mod/scripting/basebans')
helpers.CopyFiles('plugins/funcommands', 'addons/source2mod/scripting/funcommands')
helpers.CopyFiles('plugins/playercommands', 'addons/source2mod/scripting/playercommands')

with open(os.path.join(builder.sourcePath, 'configs/languages.cfg'), 'r') as f:
  language_re = re.compile(r'^\s*"([^"]+)"\s+"[^"]+"')
  added_languages = set(["en"])
  for line in f.read().splitlines():
    match = language_re.match(line)
    if match:
      lang_code = match.group(1)
      if lang_code in added_languages:
        continue
      output_path = os.path.join('addons/source2mod/translations', lang_code)
      helpers.CreateFolders([output_path])
      helpers.CopyFiles(os.path.join('translations', lang_code), output_path)
      added_languages.add(lang_code)
